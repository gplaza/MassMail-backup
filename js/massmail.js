function flashMessage(text,error){    if($("#successMessage").length < 1)    {        //If the message div doesn't exist, create it        $("body").append("<div id='successMessage' style='text-align:center;vertical-align:middle;width:400px;position:absolute;top:200px;left:300px;border:2px solid black;background:green;margin:20px;display:none'>" + text + "</div>");    }    else    {        //Else, update the text        $("#successMessage").html(text);    }    // div color    $("#successMessage").css("background-color", error ? "green" : "red");    //Fade message in    $("#successMessage").show('slow');    //Fade message out in 5 seconds    setTimeout('$("#successMessage").hide("slow")',5000);}function createRow(button,url){	var line = button.parents().eq(1);	var cell = button.parent();	var empresa = line.find("#empresa").val();	var newID = '';		if(empresa != '') {		$.ajax({ 			type: "POST", 			url: url,			data: { empresa: empresa },			success: function(newID) { 								// change the ID of the line				var id = line.attr('id');				line.attr('id',id + newID);								// change the ID of all children of the line				line.find('[id]').each(function() {					id = $(this).attr('id');					$(this).attr('id',id + newID);				 });								// add the action button to the line				var action1 = '<button onclick="javascript:changeRow(\'' + newID + '\');" class="edit">Editar</button>';				var action2 = '<button onclick="javascript:saveRow(\'' + newID + '\',\'save.php\');" class="save">Grabar</button>';				var action3 = '<button onclick="javascript:deleteRow(\'' + newID + '\',\'delete.php\');" class="delete">Quitar</button>';					cell.html(action1 + action2 + action3);				setActionButton();								saveRow(newID,'save.php');								} 			}); 			} else {				alert("Nombre de empresa obligatorio");		return false;	}}function add(nameList){	var cell1 = '<td style="white-space:nowrap;" id="entity"><input id="empresa" type="text" /></td>';	var cell2 = '<td><ul id="mails"></ul></td>';	var cell3 = '<td style="font-size:9;"><ul id="files"></ul></td>';	var cell4 = '<td align="center" ><input type="checkbox" name="send[]" id="send" /></td>';	var cell5 = '<td align="center" ><img src="img/ajax-loader.gif" style="display:none;" id="load" alt="loader" /></td>';	var cell6 = '<td align="center" style="width:100px;" ><button onclick="javascript:createRow($(this),\'add.php\');" class="save" >Grabar</button></td>';		$('<tr id="line">' + cell1 + cell2 + cell3 + cell4 + cell5 + cell6 + '</tr>').prependTo('#empresas > tbody');	$('#mails').tagit();	setActionButton();}function setActionButton(){	$(".edit" ).button({icons: { primary: "ui-icon-pencil" },text: false});	$(".save" ).button({icons: { primary: "ui-icon-disk" },text: false});	$(".delete" ).button({icons: { primary: "ui-icon-trash" },text: false});}function send(url){ 	var total = 0;	var QCount = 0;	var addToprogress = 0;	$('#progressbar').progressbar('option','value', 0);	$('#loading_send').show();		$("input[name='send[]']").each(function() {		if ($(this).attr('checked')) {			var id = $(this).attr('id').replace("send", "");			var mails = getMails(id);			var files = getFiles(id);						if (mails.length > 0 && files != '') {				total++;				addToprogress = 100 / total;			}					}	});		$("input[name='send[]']").each(function() {		if ($(this).attr('checked')) {						var id = $(this).attr('id').replace("send", "");			var img = $('#load' + id);			img.show();						var emp = $('#empresa' + id).val();			var mails = getMails(id);			var files = getFiles(id);			req = { 'mails[]': mails, AttachedFiles: files, empresa: emp };						if (mails.length > 0 && files != '') {					$.ajaxq ('mailQ', { 					type: 'POST', 					url: url, 					cache: false, 					data: req, 					success: function(msg) {						QCount++;														if (msg == '') 							img.attr('src','img/good.png');						else							img.attr('src','img/bad.png');															progress(addToprogress);													if (QCount == total)							$('#loading_send').hide();					}				});			} else {								QCount++;				img.attr('src','img/bad.png');				progress(addToprogress);								if(QCount == total)					$('#loading_send').hide();			}		}	});}function progress(add){	var value = $('#progressbar').progressbar('option','value');	$('#progressbar').progressbar('option','value',value + add);}function cancelSend(){	$.ajaxq('mailQ');	$('#loading_send').hide();		$("input[name='send[]']").each(function() {		if ($(this).attr('checked')) {			var id = $(this).attr('id').replace("send", "");			var img = $('#load' + id);			if (img.attr('src') == 'img/ajax-loader.gif')				img.hide();		}	});}function getFiles(id){	var files = '';		$('#files' + id).find('a').each( function() { 		var file =  $(this).attr('href');			if (file != '')				files += file + ';'	});		return files;}function getMails(id){	var result = new Array();	var i = 0;		$('#mails' + id).find('li').each( function() {				var mail = $(this).text();		var size = mail.length;				if (mail != '') 		{						if (mail.substring(size - 1,size) == "\xd7")				mail = mail.substring(0,size - 1);			result[i++] = mail;		}	});		return result;}function changeRow(id){	$('#mails' + id).tagit();	var empresaName = $('#empresa' + id).val();	$('#entity' + id).html('<input id="empresa' + id + '" type="text" value="' + empresaName + '" />');}function saveRow(id,url){		var empresa = $('#empresa' + id).val();	$('#entity' + id).html(empresa + '<input id="empresa' + id + '" type="hidden" value="' + empresa + '" />');		var mails = getMails(id);		$('#mails' + id).removeAttr('class');//.removeClass();	var html = "";		for (var j in mails)		html += '<li>' + mails[j] + '</li>'; 			$('#mails' + id).html(html);		req = { 'mails[]': mails, empresa: empresa, id : id };		$.ajax({ type: "POST", url: url , data: req }); }function deleteRow(id,url){	req = { id : id };	$.ajax({ 		type: "POST", 		url: url , 		data: req, 		success : function(msg){ flashMessage(msg,true); $('#line' + id).remove();},		error : function(response,msg) {flashMessage(msg,false);}	});}$(document).ready(function() { 		$('#tabs').tabs();	$('#actionSend').button();	$('#actionAdd').button();	$('#changeView').button();	$('#search').button();	$('#cancelSend').button();	$('#progressbar').progressbar({ value: 0 });			$("#empresa_search").autocomplete({		source: function(request, response){ $.post("searchEmpresa.php", {data:request.term}, function(data){ response($.map(data, function(item) { return { label: item.nombre, value: item.id }}))}, "json"); },		dataType: "json",		cache: false,		focus: function(event, ui) { return false; },		select: function(event, ui) { this.value = ui.item.label; $('#empresa_search_id').val(ui.item.value); return false;}	});	setActionButton();		$("#selectAllLine").click(function()							{				var checked_status = this.checked;				$("input[name='send[]']").each(function()				{					this.checked = checked_status;				});			});				});